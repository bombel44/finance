<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">Portfolio Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Favicon -->
    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>" rel="icon">
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SortableJS (for Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js" xintegrity="sha512-TelkP3PCMJv+viJSvGijkE3L/H8aLxtG5LM2o82lILoLC/S2rM/vY/SwLSjT42Mu/lzaKb/i/iR0F/n/Gmyhsg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
        }

        .footer {
            flex-shrink: 0;
        }

        /* Profit/Loss Colors */
        .pl-profit {
            color: var(--bs-success);
        }
        .pl-loss {
            color: var(--bs-danger);
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            z-index: 1000;
            width: calc(100% - 1.5rem); /* Match form padding */
        }

        /* Helper for alignment in accordion */
        .accordion-header .btn-group {
            margin-left: auto;
            padding-left: 1rem;
        }
        
        .accordion-button:not(.collapsed) {
            box-shadow: none;
        }
        .accordion-button:focus {
             box-shadow: none;
        }
        
        /* Ensure inputs in accordion header are clickable */
        .accordion-header .form-control,
        .accordion-header .btn,
        .accordion-header .input-group-text {
            z-index: 2; /* Place above the accordion button's click area */
            position: relative;
        }
        
        /* New asset form row styling */
        #new-asset-form-row {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
        }
        
        .asset-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 1rem;
            width: 100%;
        }
        
        /* Responsive grid for asset summary */
        @media (min-width: 768px) {
            .asset-summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 992px) {
            .asset-summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Custom styling for header stats */
        .header-stat {
            line-height: 1.2;
        }
        
        /* Edit Lot Row */
        .edit-lot-input {
            width: 90px;
        }
        .edit-lot-input-units { /* Wider input for units */
             width: 120px;
        }
        
        /* Import button styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
        
        /* Drag and Drop Styles */
        .asset-drag-handle {
            cursor: move; /* Use 'move' cursor for grabbing */
            padding: 0.5rem 0.75rem;
            margin-right: 0.5rem;
            color: var(--bs-secondary-color);
        }
        .lot-drag-handle {
            cursor: move;
            padding: 0 0.5rem;
            color: var(--bs-secondary-color);
            text-align: center;
        }
        
        /* Style for item being dragged */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--bs-secondary-bg);
        }
        .sortable-chosen {
            background: var(--bs-secondary-bg);
        }
        
    </style>
</head>
<body class="bg-body-tertiary">

    <!-- Header / Navbar -->
    <header class="p-3 mb-3 border-bottom bg-body-secondary shadow-sm">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-decoration-none h4 mb-0 me-lg-auto">
                     <span class="ms-2" data-lang-key="title">Portfolio Tracker</span>
                </a>

                <!-- Main Currency Selector -->
                <div class="ms-3">
                    <div class="input-group input-group-sm">
                        <label class="input-group-text" for="main-currency-select" data-lang-key="main_currency">Main Currency</label>
                        <select class="form-select" id="main-currency-select">
                            <option value="PLN" selected>PLN</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>

                <div class="ms-3">
                    <button class="btn btn-outline-secondary" id="lang-toggle-btn">PL</button>
                    <button class="btn btn-outline-secondary" id="theme-toggle-btn">
                        <i class="bi bi-sun-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mt-4">
        
        <!-- Portfolio Header -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <div class="d-flex align-items-center mb-2 mb-md-0">
                <h2 data-lang-key="my_portfolio" class="mb-0">My Portfolio</h2>
                
                <!-- Auto-Refresh Controls -->
                <div class="input-group input-group-sm ms-3" style="width: auto;">
                    <label class="input-group-text" for="auto-refresh-select" data-lang-key="auto_refresh">Auto-Refresh</label>
                    <select class="form-select" id="auto-refresh-select">
                        <option value="5s">5 sec</option>
                        <option value="10s" selected>10 sec</option>
                        <option value="30s">30 sec</option>
                        <option value="60s">1 min</option>
                        <option value="300s">5 min</option>
                        <option value="600s">10 min</option>
                        <option value="900s">15 min</option>
                        <option value="manual" data-lang-key="manual_refresh">Manual</option>
                    </select>
                </div>
                
                <button class="btn btn-outline-primary btn-sm ms-2" id="refresh-prices-btn">
                    <i class="bi bi-arrow-clockwise"></i> <span data-lang-key="refresh_prices">Refresh Prices</span>
                </button>
            </div>
            <button class="btn btn-primary" id="add-asset-btn">
                <i class="bi bi-plus-circle-fill me-1"></i> <span data-lang-key="add_asset">Add Asset</span>
            </button>
        </div>

        <!-- New Asset Form (Initially hidden) -->
        <div id="new-asset-form-row" class="p-3 mb-3 d-none bg-body-secondary rounded-3">
            <h5 data-lang-key="add_new_asset">Add New Asset</h5>
            <p class="small text-muted" data-lang-key="add_asset_desc">
                Enter the asset's symbol, name, and details for your first purchase lot.
            </p>
            <div class="row g-2 align-items-end">
                <div class="col-md-3 col-6 position-relative">
                    <label for="new-symbol" class="form-label small" data-lang-key="symbol">Symbol</label>
                    <input type="text" class="form-control" id="new-symbol" placeholder="e.g., AAPL" autocomplete="off">
                    <div class="list-group autocomplete-dropdown d-none" id="autocomplete-list">
                        <!-- Autocomplete items go here -->
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <label for="new-name" class="form-label small" data-lang-key="asset_name">Asset Name</label>
                    <input type="text" class="form-control" id="new-name" placeholder="e.g., Apple Inc.">
                </div>
                <div class="col-md-2 col-6">
                    <label for="new-units" class="form-label small" data-lang-key="units">Units</label>
                    <input type="number" class="form-control" id="new-units" placeholder="0.00000" step="0.00001">
                </div>
                <div class="col-md-2 col-6">
                    <label for="new-cost" class="form-label small" data-lang-key="cost_per_unit">Cost / Unit</label>
                    <input type="number" class="form-control" id="new-cost" placeholder="0.00">
                </div>
                <div class="col-md-2 col-12"> <!-- Adjusted grid -->
                    <label for="new-commission" class="form-label small" data-lang-key="commission">Commission</label>
                    <input type="number" class="form-control" id="new-commission" placeholder="0.00">
                </div>
            </div>
            <div class="row mt-3"> <!-- Buttons on new row -->
                <div class="col-12 d-flex">
                    <button class="btn btn-success w-50 me-1" id="save-new-asset-btn">
                        <i class="bi bi-check-lg"></i> <span data-lang-key="save">Save</span>
                    </button>
                    <button class="btn btn-secondary w-50 ms-1" id="cancel-new-asset-btn">
                        <i class="bi bi-x-lg"></i> <span data-lang-key="cancel">Cancel</span>
                    </button>
                </div>
            </div>
            <!-- Autocomplete info box -->
            <div class="form-text mt-2" data-lang-key="autocomplete_info">
                Start typing a symbol to search.
            </div>
        </div>
        
        <!-- Add Lot Form (Template, hidden) -->
        <template id="add-lot-form-template">
             <div class="row g-2 align-items-end p-3 bg-body-tertiary rounded-bottom" data-form-type="add-lot">
                <div class="col-md-3">
                    <label class="form-label small" data-lang-key="units">Units</label>
                    <input type="number" class="form-control" placeholder="0.00000" step="0.00001" data-input="units">
                </div>
                <div class="col-md-3">
                    <label class="form-label small" data-lang-key="cost_per_unit">Cost / Unit</label>
                    <input type="number" class="form-control" placeholder="0.00" data-input="cost">
                </div>
                <div class="col-md-3">
                    <label class="form-label small" data-lang-key="commission">Commission</label>
                    <input type="number" class="form-control" placeholder="0.00" data-input="commission">
                </div>
                <div class="col-md-3 d-flex mt-3 mt-md-0">
                    <button class="btn btn-success w-50 me-1" data-action="save-lot">
                        <i class="bi bi-check-lg"></i> <span data-lang-key="save">Save</span>
                    </button>
                    <button class="btn btn-secondary w-50 ms-1" data-action="cancel-lot">
                        <i class="bi bi-x-lg"></i> <span data-lang-key="cancel">Cancel</span>
                    </button>
                </div>
            </div>
        </template>
        
        <!-- Total Portfolio Summary -->
        <div class="card bg-body-secondary mb-3" id="total-portfolio-summary">
            <div class="card-body p-3">
                <div class="row g-3">
                    <div class="col-md-6 col-12">
                        <span class="small text-muted" data-lang-key="total_portfolio_value">Total Portfolio Value</span>
                        <div class="fs-4 fw-bold" id="total-value-display">...</div>
                    </div>
                    <div class="col-md-6 col-12">
                        <span class="small text-muted" data-lang-key="total_portfolio_pl">Total Portfolio P/L</span>
                        <div class="fs-4 fw-bold" id="total-pl-display">...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Portfolio List / Accordion -->
        <div class="accordion" id="portfolio-list">
            <!-- Assets will be dynamically inserted here by JS -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-body-secondary border-top">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="text-muted" id="version-text">v1.8.0</span> <!-- Version bump for dnd -->
            
            <div class="btn-group" role="group">
                <!-- Import Button -->
                <button class="btn btn-outline-secondary btn-sm file-input-wrapper">
                    <i class="bi bi-upload"></i> <span data-lang-key="import_settings">Import</span>
                    <input type="file" id="import-file-input" accept=".json">
                </button>
                
                <!-- Export Button -->
                <button class="btn btn-outline-secondary btn-sm" id="export-settings-btn">
                    <i class="bi bi-download"></i> <span data-lang-key="export_settings">Export</span>
                </button>
                
                <!-- Sources Button -->
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#sourcesModal" data-lang-key="sources">
                    Sources
                </button>
            </div>
        </div>
    </footer>

    <!-- Sources Modal -->
    <div class="modal fade" id="sourcesModal" tabindex="1" aria-labelledby="sourcesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sourcesModalLabel" data-lang-key="sources">Sources</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p data-lang-key="sources_modal_p1">
                        This application is a client-side portfolio tracker. All data is saved in your browser's local storage.
                    </p>
                    <p data-lang-key="sources_modal_p2">
                        This application uses a server-side proxy to fetch live market data from Yahoo Finance APIs (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`).
                    </p>
                    <p data-lang-key="sources_modal_p3">
                        All data is fetched securely through your own server, avoiding browser CORS restrictions.
                    </p>
                    <p class="mt-3">
                        Drag-and-drop functionality is provided by <a href="https://github.com/SortableJS/Sortable" target="_blank">SortableJS</a>.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-lang-key="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONSTANTS ---
            const STORAGE_KEYS = {
                portfolio: 'portfolioTrackerPortfolio_v1',
                prices: 'portfolioTrackerPrices_v1',
                theme: 'portfolioTrackerTheme_v1',
                lang: 'portfolioTrackerLang_v1',
                refresh: 'portfolioTrackerRefresh_v1',
                mainCurrency: 'portfolioTrackerMainCurrency_v1' // For main currency
            };

            const REFRESH_INTERVALS = {
                '5s': 5000,
                '10s': 10000,
                '30s': 30000,
                '60s': 60000,
                '300s': 300000, // 5 min
                '600s': 600000, // 10 min
                '900s': 900000, // 15 min
                'manual': 0
            };
            
            // All keys to backup for import/export
            const ALL_STORAGE_KEYS = Object.values(STORAGE_KEYS);

            const LANGUAGES = {
                en: {
                    title: "Portfolio Tracker",
                    my_portfolio: "My Portfolio",
                    add_asset: "Add Asset",
                    add_new_asset: "Add New Asset",
                    add_asset_desc: "Enter the asset's symbol, name, and details for your first purchase lot.",
                    symbol: "Symbol",
                    asset_name: "Asset Name",
                    units: "Units",
                    cost_per_unit: "Cost / Unit",
                    commission: "Commission",
                    save: "Save",
                    cancel: "Cancel",
                    autocomplete_info: "Start typing a symbol to search.",
                    sources: "Sources",
                    sources_modal_p1: "This application is a client-side portfolio tracker. All data is saved in your browser's local storage.",
                    sources_modal_p2: "This application uses a server-side proxy to fetch live market data from Yahoo Finance APIs (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`).",
                    sources_modal_p3: "All data is fetched securely through your own server, avoiding browser CORS restrictions.",
                    close: "Close",
                    total_units: "Total Units",
                    avg_cost: "Avg. Cost",
                    total_value: "Total Value",
                    total_pl: "Total P/L",
                    current_price: "Current Price",
                    set: "Set",
                    lots_table: "Lots Table",
                    purchase_cost: "Purchase Cost",
                    current_value: "Current Value",
                    pl: "P/L",
                    actions: "Actions",
                    edit: "Edit",
                    add_lot: "Add Lot",
                    remove_asset: "Remove Asset",
                    lot_cost: "Lot Cost",
                    refresh_prices: "Refresh Prices",
                    auto_refresh: "Auto-Refresh",
                    manual_refresh: "Manual",
                    main_currency: "Main Currency",
                    exchange_rate: "Exch. Rate",
                    current_value_main: "Value (Main)",
                    pl_main: "P/L (Main)",
                    total_portfolio_value: "Total Portfolio Value",
                    total_portfolio_pl: "Total Portfolio P/L",
                    portfolio_empty: "Your portfolio is empty. Click \"Add Asset\" to get started.",
                    fetching_prices: "Fetching prices...",
                    confirm_remove_asset: "Are you sure you want to remove this entire asset and all its lots?",
                    confirm_remove_lot: "Are you sure you want to remove this lot?",
                    invalid_input: "Please enter valid numbers for all fields.",
                    import_settings: "Import",
                    export_settings: "Export",
                    import_confirm: "This will overwrite all current settings and portfolio data. Are you sure?",
                    import_error_title: "Import Error",
                    import_error_invalid_file: "Invalid file format. Please choose a .json file exported from this application.",
                    import_success: "Settings imported successfully. The page will now reload."
                },
                pl: {
                    title: "Monitor Portfela",
                    my_portfolio: "M贸j Portfel",
                    add_asset: "Dodaj Aktywo",
                    add_new_asset: "Dodaj Nowe Aktywo",
                    add_asset_desc: "Wprowad藕 symbol, nazw aktywa oraz szczeg贸ly pierwszej transakcji zakupu.",
                    symbol: "Symbol",
                    asset_name: "Nazwa Aktywa",
                    units: "Ilo",
                    cost_per_unit: "Koszt / Jedn.",
                    commission: "Prowizja",
                    save: "Zapisz",
                    cancel: "Anuluj",
                    autocomplete_info: "Zacznij wpisywa symbol, aby wyszuka.",
                    sources: "殴r贸da",
                    sources_modal_p1: "Ta aplikacja to klient-side'owy monitor portfela. Wszystkie dane s zapisywane w lokalnej pamici przegldarki.",
                    sources_modal_p2: "Ta aplikacja u偶ywa serwerowego proxy do pobierania danych rynkowych z API Yahoo Finance (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`).",
                    sources_modal_p3: "Wszystkie dane s pobierane bezpiecznie przez tw贸j wasny serwer, co pozwala omin ograniczenia CORS przegldarki.",
                    close: "Zamknij",
                    total_units: "Suma Jedn.",
                    avg_cost: "r. Koszt",
                    total_value: "Cak. Warto",
                    total_pl: "Cak. Z/S",
                    current_price: "Aktualna Cena",
                    set: "Ustaw",
                    lots_table: "Tabela Transakcji",
                    purchase_cost: "Koszt Zakupu",
                    current_value: "Aktualna Warto",
                    pl: "Z/S",
                    actions: "Akcje",
                    edit: "Edytuj",
                    add_lot: "Dodaj Transakcj",
                    remove_asset: "Usu Aktywo",
                    lot_cost: "Koszt Trans.",
                    refresh_prices: "Odwie偶 Ceny",
                    auto_refresh: "Auto-Odwie偶anie",
                    manual_refresh: "Rczne",
                    main_currency: "G贸wna Waluta",
                    exchange_rate: "Kurs Wym.",
                    current_value_main: "Warto (G.)",
                    pl_main: "Z/S (G.)",
                    total_portfolio_value: "Cakowita Warto Portfela",
                    total_portfolio_pl: "Cakowity Z/S Portfela",
                    portfolio_empty: "Tw贸j portfel jest pusty. Kliknij \"Dodaj Aktywo\", aby zacz.",
                    fetching_prices: "Pobieranie cen...",
                    confirm_remove_asset: "Czy na pewno chcesz usun to aktywo i wszystkie jego transakcje?",
                    confirm_remove_lot: "Czy na pewno chcesz usun t transakcj?",
                    invalid_input: "Prosz wprowadzi prawidowe liczby we wszystkich polach.",
                    import_settings: "Importuj",
                    export_settings: "Eksportuj",
                    import_confirm: "Spowoduje to nadpisanie wszystkich obecnych ustawie i danych portfela. Jeste pewien?",
                    import_error_title: "Bd Importu",
                    import_error_invalid_file: "Nieprawidowy format pliku. Prosz wybra plik .json wyeksportowany z tej aplikacji.",
                    import_success: "Ustawienia zaimportowane pomylnie. Strona zostanie teraz ponownie zaadowana."
                }
            };

            // --- STATE ---
            let portfolio = [];
            let currentPrices = {}; // { SYMBOL: { price: 123.45, currency: 'USD' } }
            let exchangeRates = {}; // { 'USDPLN=X': 4.01, 'EURPLN=X': 4.32 }
            let currentTheme = 'dark';
            let currentLang = 'en';
            let mainCurrency = 'PLN'; // Default main currency
            let autocompleteDebounceTimer;
            let openAccordionItems = new Set(); // For keeping rows open
            let autoRefreshTimer = null; // For auto-refresh interval
            let currentRefreshKey = '10s'; // Default refresh state
            let editingLotId = null; // Track which lot is being edited
            let activeSortable = null; // To disable/enable sortable instances
            
            // --- PROXY SCRIPT PATH ---
            const PROXY_SCRIPT = 'proxy.php';

            // --- DOM REFERENCES ---
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const mainCurrencySelect = document.getElementById('main-currency-select');
            const portfolioListEl = document.getElementById('portfolio-list');
            const addAssetBtn = document.getElementById('add-asset-btn');
            const refreshPricesBtn = document.getElementById('refresh-prices-btn');
            const autoRefreshSelect = document.getElementById('auto-refresh-select'); // Auto-refresh dropdown
            
            // Total Summary
            const totalPortfolioSummaryEl = document.getElementById('total-portfolio-summary');
            const totalValueDisplayEl = document.getElementById('total-value-display');
            const totalPLDisplayEl = document.getElementById('total-pl-display');
            
            // New Asset Form
            const newAssetForm = document.getElementById('new-asset-form-row');
            const newSymbolInput = document.getElementById('new-symbol');
            const autocompleteList = document.getElementById('autocomplete-list');
            const newNameInput = document.getElementById('new-name');
            const newUnitsInput = document.getElementById('new-units');
            const newCostInput = document.getElementById('new-cost');
            const newCommissionInput = document.getElementById('new-commission'); // Commission input
            const saveNewAssetBtn = document.getElementById('save-new-asset-btn');
            const cancelNewAssetBtn = document.getElementById('cancel-new-asset-btn');
            
            // Add Lot Template
            const addLotFormTemplate = document.getElementById('add-lot-form-template');
            
            // Import/Export
            const exportSettingsBtn = document.getElementById('export-settings-btn');
            const importFileInput = document.getElementById('import-file-input');

            // --- INITIALIZATION ---
            function init() {
                loadTheme();
                loadLang();
                loadMainCurrency();
                loadPortfolio();
                renderPortfolio();
                attachEventListeners();
                fetchPrices(); // Fetch prices on load
                loadAutoRefresh(); // Load refresh settings and start timer
            }
            
            // --- THEME FUNCTIONS ---
            function loadTheme() {
                const storedTheme = localStorage.getItem(STORAGE_KEYS.theme);
                currentTheme = storedTheme || 'dark'; // Default dark
                applyTheme(currentTheme);
            }

            function applyTheme(theme) {
                document.documentElement.dataset.bsTheme = theme;
                themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
                currentTheme = theme;
                localStorage.setItem(STORAGE_KEYS.theme, theme);
            }

            function toggleTheme() {
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            }

            // --- LANGUAGE FUNCTIONS ---
            function loadLang() {
                const storedLang = localStorage.getItem(STORAGE_KEYS.lang);
                currentLang = storedLang || 'en'; // Default English
                applyLang(currentLang);
            }

            function applyLang(lang) {
                currentLang = lang;
                localStorage.setItem(STORAGE_KEYS.lang, lang);
                langToggleBtn.textContent = lang === 'en' ? 'PL' : 'EN';
                
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if (LANGUAGES[lang] && LANGUAGES[lang][key]) {
                        el.innerHTML = LANGUAGES[lang][key];
                    }
                });
                
                // Update dynamic placeholder text
                document.documentElement.lang = lang;
            }

            function toggleLang() {
                applyLang(currentLang === 'en' ? 'pl' : 'en');
                // Re-render to update dynamic text in portfolio
                renderPortfolio();
            }
            
            // --- CURRENCY FUNCTIONS ---
            function loadMainCurrency() {
                const storedCurrency = localStorage.getItem(STORAGE_KEYS.mainCurrency);
                mainCurrency = storedCurrency || 'PLN'; // Default PLN
                applyMainCurrency(mainCurrency);
            }
            
            function applyMainCurrency(currency) {
                mainCurrency = currency;
                localStorage.setItem(STORAGE_KEYS.mainCurrency, currency);
                mainCurrencySelect.value = currency;
                
                // We need to fetch prices again to get the right exchange rates
                // and re-render the whole portfolio
                fetchPrices();
                // renderPortfolio() will be called by fetchPrices()
            }
            
            /**
             * Gets the exchange rate for a given asset currency against the main currency.
             */
            function getExchangeRate(assetCurrency) {
                if (assetCurrency === mainCurrency) {
                    return 1;
                }
                const pair = `${assetCurrency}${mainCurrency}=X`;
                return exchangeRates[pair] || 0; // Return 0 if rate not found
            }
            
            /**
             * Converts a value from its asset currency to the main currency.
             */
            function convertToMainCurrency(value, assetCurrency) {
                if (typeof value !== 'number') return 0;
                
                const rate = getExchangeRate(assetCurrency);
                return value * rate;
            }

            // --- PORTFOLIO DATA FUNCTIONS ---
            function loadPortfolio() {
                // Wrap in try...catch to prevent bad data from crashing the app
                try {
                    portfolio = JSON.parse(localStorage.getItem(STORAGE_KEYS.portfolio)) || [];
                } catch (e) {
                    console.error('Failed to parse portfolio from localStorage', e);
                    portfolio = []; // Reset portfolio
                    localStorage.removeItem(STORAGE_KEYS.portfolio); // Clear bad data
                }
                
                try {
                    currentPrices = JSON.parse(localStorage.getItem(STORAGE_KEYS.prices)) || {}; // Was array, should be object
                } catch (e) {
                    console.error('Failed to parse prices from localStorage', e);
                    currentPrices = {}; // Reset prices
                    localStorage.removeItem(STORAGE_KEYS.prices); // Clear bad data
                }
            }

            function savePortfolio() {
                localStorage.setItem(STORAGE_KEYS.portfolio, JSON.stringify(portfolio));
                localStorage.setItem(STORAGE_KEYS.prices, JSON.stringify(currentPrices));
            }

            // --- AUTO-REFRESH FUNCTIONS ---
            function loadAutoRefresh() {
                const storedKey = localStorage.getItem(STORAGE_KEYS.refresh) || '10s'; // Default 10s
                applyAutoRefresh(storedKey);
            }

            function applyAutoRefresh(key) {
                currentRefreshKey = key;
                localStorage.setItem(STORAGE_KEYS.refresh, key);
                autoRefreshSelect.value = key; // Update dropdown to match

                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }

                if (key === 'manual') {
                    refreshPricesBtn.disabled = false;
                } else {
                    refreshPricesBtn.disabled = true;
                    const interval = REFRESH_INTERVALS[key];
                    if (interval > 0) {
                        autoRefreshTimer = setInterval(fetchPrices, interval);
                    }
                }
            }

            // --- API FUNCTIONS ---
            
            function debounce(func, delay) {
                return function(...args) {
                    clearTimeout(autocompleteDebounceTimer);
                    autocompleteDebounceTimer = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            }
            
            async function fetchAutocomplete(query) {
                if (query.length < 1) {
                    autocompleteList.classList.add('d-none');
                    return;
                }
                
                try {
                    const targetApiUrl = `https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&lang=en-US&region=US&quotesCount=7&enableCb=false&enableNavLinks=true`;
                    const response = await fetch(`${PROXY_SCRIPT}?url=${encodeURIComponent(targetApiUrl)}`);
                    
                    if (!response.ok) throw new Error('Autocomplete API response not ok');
                    
                    const data = await response.json();
                    const suggestions = data.quotes; 
                    
                    renderAutocomplete(suggestions);
                    
                } catch (error) {
                    console.error('Error fetching autocomplete:', error);
                    autocompleteList.classList.add('d-none');
                }
            }
            
            function renderAutocomplete(suggestions) {
                autocompleteList.innerHTML = '';
                if (!suggestions || suggestions.length === 0) {
                    autocompleteList.classList.add('d-none');
                    return;
                }
                
                suggestions.slice(0, 7).forEach(item => {
                    const name = item.longname || item.shortname || item.symbol;
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'list-group-item list-group-item-action';
                    el.innerHTML = `<strong>${item.symbol}</strong> - <small>${name}</small>`;
                    el.dataset.symbol = item.symbol;
                    el.dataset.name = name;
                    
                    el.addEventListener('click', () => {
                        newSymbolInput.value = item.symbol;
                        newNameInput.value = name;
                        autocompleteList.classList.add('d-none');
                        newUnitsInput.focus();
                    });
                    
                    autocompleteList.appendChild(el);
                });
                
                autocompleteList.classList.remove('d-none');
            }
            
            async function fetchYahooPriceData(symbol) {
                try {
                    const period2 = Math.floor(Date.now() / 1000); // Now
                    const period1 = period2 - (7 * 24 * 60 * 60); // 7 days ago
                    
                    const targetApiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${period1}&period2=${period2}&interval=1d&includePrePost=true&events=div%7Csplit%7Cearn&lang=en-US&region=US`;
                    
                    const response = await fetch(`${PROXY_SCRIPT}?url=${encodeURIComponent(targetApiUrl)}`);
                    
                    if (!response.ok) {
                        console.warn(`Failed to fetch price for ${symbol}`);
                        return null;
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0] && data.chart.result[0].meta) {
                        const meta = data.chart.result[0].meta;
                        const price = meta.regularMarketPrice;
                        const currency = meta.currency || 'USD';
                        return { symbol, price, currency };
                    } else {
                        console.warn(`Unexpected data structure for ${symbol}`, data);
                        return null;
                    }
                } catch (err) {
                    console.error(`Error fetching ${symbol}:`, err);
                    return null;
                }
            }
            
            async function fetchPrices() {
                if (portfolio.length === 0) {
                    renderPortfolio();
                    return;
                }
                
                const originalBtnText = refreshPricesBtn.innerHTML;
                refreshPricesBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <span data-lang-key="fetching_prices">Fetching...</span>`;
                refreshPricesBtn.disabled = true;
                applyLang(currentLang);

                const assetSymbols = portfolio.map(asset => asset.symbol);
                const requiredRates = new Set();
                
                // First pass: Fetch asset prices
                const pricePromises = assetSymbols.map(fetchYahooPriceData);
                const assetResults = await Promise.all(pricePromises);
                
                let pricesUpdated = false;
                assetResults.forEach(result => {
                    if (result && result.price !== undefined) {
                        currentPrices[result.symbol] = {
                            price: result.price || 0,
                            currency: result.currency || 'USD'
                        };
                        pricesUpdated = true;
                        
                        if (result.currency !== mainCurrency) {
                            requiredRates.add(`${result.currency}${mainCurrency}=X`);
                        }
                    }
                });
                
                // 2. Second pass: Fetch all required exchange rates
                const ratePromises = Array.from(requiredRates).map(fetchYahooPriceData);
                const rateResults = await Promise.all(ratePromises);
                
                exchangeRates = {};
                rateResults.forEach(result => {
                    if (result && result.price) {
                        exchangeRates[result.symbol] = result.price;
                    }
                });

                if (pricesUpdated) {
                    savePortfolio();
                }
                
                renderPortfolio();
                    
                refreshPricesBtn.innerHTML = originalBtnText;
                if (currentRefreshKey === 'manual') {
                    refreshPricesBtn.disabled = false;
                }
                applyLang(currentLang);
            }


            // --- RENDERING ---
            
            /**
             * Controls the state of all SortableJS instances.
             * Used to disable dragging while editing/adding lots.
             */
            function setSortableState(enabled) {
                if (!activeSortable) return;
                
                // assetSortable might be null if portfolio was empty, so check
                if (activeSortable.assetSortable) {
                    activeSortable.assetSortable.option("disabled", !enabled);
                }
                activeSortable.lotSortables.forEach(s => s.option("disabled", !enabled));
            }

            function renderPortfolio() {
                // Destroy old sortable instances if they exist
                if (activeSortable) {
                    // FIX: Check if assetSortable is not null before destroying
                    if (activeSortable.assetSortable) {
                        activeSortable.assetSortable.destroy();
                    }
                    activeSortable.lotSortables.forEach(s => s.destroy());
                }
                activeSortable = { assetSortable: null, lotSortables: [] };
                
                portfolioListEl.innerHTML = ''; // Clear list
                
                if (portfolio.length === 0) {
                     portfolioListEl.innerHTML = `<div class="alert alert-info" data-lang-key="portfolio_empty">Your portfolio is empty. Click "Add Asset" to get started.</div>`;
                     totalPortfolioSummaryEl.classList.add('d-none'); // Hide summary
                     applyLang(currentLang); // Apply lang to new element
                     return; // <-- This was causing the issue
                }
                
                totalPortfolioSummaryEl.classList.remove('d-none');
                
                let grandTotalValue = 0;
                let grandTotalCost = 0;

                portfolio.forEach(asset => {
                    const { assetEl, totalValueMain, totalCostMain } = createAssetElement(asset);
                    portfolioListEl.appendChild(assetEl);
                    
                    grandTotalValue += totalValueMain;
                    grandTotalCost += totalCostMain;
                });
                
                // Calculate and display grand totals
                const grandTotalPL = grandTotalValue - grandTotalCost;
                const grandTotalPLPercent = grandTotalCost > 0 ? (grandTotalPL / grandTotalCost) * 100 : 0;
                const plInfo = getPnLInfo(grandTotalPL);

                totalValueDisplayEl.textContent = formatCurrency(grandTotalValue, mainCurrency);
                totalPLDisplayEl.innerHTML = `
                    ${formatCurrency(grandTotalPL, mainCurrency)}
                    <span class="fs-6 fw-normal ${plInfo.textClass}">
                        (${formatPercent(grandTotalPLPercent)})
                        <i class="bi ${plInfo.icon}"></i>
                    </span>
                `;
                totalPLDisplayEl.className = `fs-4 fw-bold ${plInfo.textClass}`;
                
                // Re-apply language to all newly created elements
                applyLang(currentLang);
                
                // Initialize SortableJS
                initSortable();
            }
            
            function createAssetElement(asset) {
                const currentPriceData = currentPrices[asset.symbol] || { price: 0, currency: 'USD' };
                const currentPrice = currentPriceData.price;
                const assetCurrency = currentPriceData.currency;
                
                const exchangeRate = getExchangeRate(assetCurrency);
                
                // Calculate totals in ASSET currency
                const totalUnits = asset.lots.reduce((sum, lot) => sum + (lot.units || 0), 0);
                const totalCost = asset.lots.reduce((sum, lot) => {
                    const commission = lot.commission || 0;
                    return sum + ((lot.units || 0) * (lot.cost || 0)) + commission;
                }, 0);
                const avgCost = totalUnits > 0 ? totalCost / totalUnits : 0;
                const totalValue = totalUnits * currentPrice;
                const totalPL = totalValue - totalCost;
                
                // Calculate totals in MAIN currency
                const totalValueMain = convertToMainCurrency(totalValue, assetCurrency);
                const totalCostMain = convertToMainCurrency(totalCost, assetCurrency);
                const totalPLMain = totalValueMain - totalCostMain;
                const totalPLPercent = totalCostMain > 0 ? (totalPLMain / totalCostMain) * 100 : 0;
                
                const plInfo = getPnLInfo(totalPLMain);
                const isExpanded = openAccordionItems.has(asset.id);
                const isDifferentCurrency = assetCurrency !== mainCurrency;

                const template = document.createElement('div');
                template.className = 'accordion-item';
                template.dataset.assetId = asset.id; // Add asset ID for sorting
                template.innerHTML = `
                    <h2 class="accordion-header">
                        <button class="accordion-button ${isExpanded ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${asset.id}">
                            <div class="d-flex flex-wrap w-100 align-items-center">
                                
                                <!-- Drag Handle -->
                                <span class="asset-drag-handle" title="Drag to reorder">
                                    <i class="bi bi-grip-vertical"></i>
                                </span>

                                <!-- Left Side: Name -->
                                <div class="me-auto">
                                    <strong class="fs-5 me-2">${asset.symbol}</strong>
                                    <span class="text-muted">${asset.name}</span>
                                    
                                    <div class="d-md-none small text-muted mt-1">
                                        ${totalUnits.toFixed(5)} <span data-lang-key="units">Units</span>
                                        &bull;
                                        ${formatCurrency(totalValueMain, mainCurrency)} <span data-lang-key="total_value">Value</span>
                                    </div>
                                </div>
                                
                                <!-- Right Side: Stats & Buttons -->
                                <div class="d-flex align-items-center">
                                    <!-- Stats (hidden on small, shown on medium+) -->
                                    <div class="d-none d-md-flex align-items-center me-3">
                                        <div class="me-3 text-end header-stat">
                                            <span class="small text-muted" data-lang-key="total_units">Total Units</span>
                                            <div class="fw-bold">${totalUnits.toFixed(5)}</div>
                                        </div>
                                        <div class="me-3 text-end header-stat">
                                            <span class="small text-muted" data-lang-key="current_price">Current Price</span>
                                            <div class="fw-bold">${formatCurrency(convertToMainCurrency(currentPrice, assetCurrency), mainCurrency)}</div>
                                        </div>
                                        <div class="me-3 text-end header-stat">
                                            <span class="small text-muted" data-lang-key="total_value">Total Value</span>
                                            <div class="fw-bold">${formatCurrency(totalValueMain, mainCurrency)}</div>
                                        </div>
                                        <div class="text-end header-stat ${plInfo.textClass}">
                                            <span class="small text-muted" data-lang-key="total_pl">Total P/L</span>
                                            <div class="fw-bold">${formatCurrency(totalPLMain, mainCurrency)} (${formatPercent(totalPLPercent)})</div>
                                        </div>
                                    </div>

                                    <!-- Buttons -->
                                    <div class="btn-group d-none d-lg-flex ms-lg-3" role="group">
                                        <button class="btn btn-sm btn-outline-success" data-action="add-lot" data-asset-id="${asset.id}" title="Add Lot">
                                            <i class="bi bi-plus-lg"></i> <span data-lang-key="add_lot">Add Lot</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" data-action="remove-asset" data-asset-id="${asset.id}" title="Remove Asset">
                                            <i class="bi bi-trash-fill"></i> <span data-lang-key="remove_asset">Remove Asset</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-${asset.id}" class="accordion-collapse collapse ${isExpanded ? 'show' : ''}">
                        <div class="accordion-body">
                            <!-- Asset Summary (in ASSET currency) -->
                            <div class="asset-summary-grid mb-3">
                                <div>
                                    <span class="small text-muted" data-lang-key="avg_cost">Avg. Cost</span>
                                    <div class="fs-5">${formatCurrency(avgCost, assetCurrency)}</div>
                                </div>
                                <div class="d-md-none">
                                    <span class="small text-muted" data-lang-key="total_value">Total Value</span>
                                    <div class="fs-5">${formatCurrency(totalValue, assetCurrency)}</div>
                                </div>
                                <div>
                                    <span class="small text-muted" data-lang-key="current_price">Current Price</span>
                                    <div class="fs-5">${formatCurrency(currentPrice, assetCurrency)}</div>
                                </div>
                                <div>
                                    <span class="small text-muted" data-lang-key="total_pl">Total P/L</span>
                                    <div class="fs-5 ${getPnLInfo(totalPL).textClass}">
                                        ${formatCurrency(totalPL, assetCurrency)}
                                    </div>
                                </div>
                                ${isDifferentCurrency ? `
                                <div>
                                    <span class="small text-muted" data-lang-key="exchange_rate">Exch. Rate</span>
                                    <div class="fs-5">1 ${assetCurrency} = ${exchangeRate.toFixed(4)} ${mainCurrency}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Small screen buttons -->
                            <div class="d-lg-none btn-group w-100 mb-3">
                                <button class="btn btn-sm btn-outline-success" data-action="add-lot" data-asset-id="${asset.id}" title="Add Lot">
                                    <i class="bi bi-plus-lg"></i> <span data-lang-key="add_lot">Add Lot</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="remove-asset" data-asset-id="${asset.id}" title="Remove Asset">
                                    <i class="bi bi-trash-fill"></i> <span data-lang-key="remove_asset">Remove Asset</span>
                                </button>
                            </div>

                            <!-- Lots Table -->
                            <h6 data-lang-key="lots_table">Lots</h6>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th></th> <!-- Column for drag handle -->
                                            <th data-lang-key="units">Units</th>
                                            <th data-lang-key="cost_per_unit">Cost / Unit</th>
                                            <th data-lang-key="commission">Commission</th>
                                            <th data-lang-key="lot_cost">Lot Cost</th>
                                            <th data-lang-key="current_value">Current Value</th>
                                            <th data-lang-key="pl">P/L</th>
                                            ${isDifferentCurrency ? `
                                            <th data-lang-key="current_value_main">Value (Main)</th>
                                            <th data-lang-key="pl_main">P/L (Main)</th>
                                            ` : ''}
                                            <th data-lang-key="actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="lots-table-body" data-asset-id="${asset.id}">
                                        ${asset.lots.map(lot => createLotRow(lot, currentPrice, assetCurrency, exchangeRate)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Add Lot Form placeholder -->
                            <div data-container="add-lot-form" data-asset-id="${asset.id}"></div>
                        </div>
                    </div>
                `;
                return { assetEl: template, totalValueMain, totalCostMain };
            }
            
            function createLotRow(lot, currentPrice, assetCurrency, exchangeRate) {
                const isDifferentCurrency = assetCurrency !== mainCurrency;
                
                if (editingLotId === lot.id) {
                    const units = lot.units || 0;
                    const cost = lot.cost || 0;
                    const commission = lot.commission || 0;
                    
                    return `
                        <tr data-lot-id="${lot.id}" data-asset-id="${lot.assetId}">
                            <td></td> <!-- Placeholder for handle -->
                            <td class="align-middle">
                                <input type="number" class="form-control form-control-sm edit-lot-input-units" data-edit="units" value="${units.toFixed(5)}" step="0.00001">
                            </td>
                            <td class="align-middle">
                                <input type="number" class="form-control form-control-sm edit-lot-input" data-edit="cost" value="${cost.toFixed(2)}">
                            </td>
                            <td class="align-middle">
                                <input type="number" class="form-control form-control-sm edit-lot-input" data-edit="commission" value="${commission.toFixed(2)}">
                            </td>
                            <td>...</td>
                            <td>...</td>
                            <td>...</td>
                            ${isDifferentCurrency ? '<td>...</td><td>...</td>' : ''}
                            <td>
                                <div class="btn-group gap-2">
                                    <button class="btn btn-outline-success btn-sm" data-action="save-edit-lot">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" data-action="cancel-edit-lot">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                // Standard view row
                const units = lot.units || 0;
                const cost = lot.cost || 0;
                const commission = lot.commission || 0;
                
                const lotCost = (units * cost) + commission;
                const lotValue = units * currentPrice;
                const lotPL = lotValue - lotCost;
                const lotPLPercent = lotCost > 0 ? (lotPL / lotCost) * 100 : 0;
                const plInfo = getPnLInfo(lotPL);
                
                let lotValueMain, lotCostMain, lotPLMain, plInfoMain;
                if (isDifferentCurrency) {
                    lotValueMain = lotValue * exchangeRate;
                    lotCostMain = lotCost * exchangeRate;
                    lotPLMain = lotValueMain - lotCostMain;
                    plInfoMain = getPnLInfo(lotPLMain);
                }
                
                return `
                    <tr data-lot-id="${lot.id}" data-asset-id="${lot.assetId}">
                        <!-- Drag Handle -->
                        <td class="lot-drag-handle" title="Drag to reorder">
                            <i class="bi bi-grip-vertical"></i>
                        </td>
                        <td>${units.toFixed(5)}</td>
                        <td>${formatCurrency(cost, assetCurrency)}</td>
                        <td>${formatCurrency(commission, assetCurrency)}</td>
                        <td>${formatCurrency(lotCost, assetCurrency)}</td>
                        <td>${formatCurrency(lotValue, assetCurrency)}</td>
                        <td class="${plInfo.textClass}">
                            ${formatCurrency(lotPL, assetCurrency)}
                            (${formatPercent(lotPLPercent)})
                        </td>
                        
                        ${isDifferentCurrency ? `
                        <td>${formatCurrency(lotValueMain, mainCurrency)}</td>
                        <td class="${plInfoMain.textClass}">
                            ${formatCurrency(lotPLMain, mainCurrency)}
                        </td>
                        ` : ''}
                        
                        <td>
                            <div class="btn-group gap-2">
                                <button class="btn btn-outline-primary btn-sm" data-action="edit-lot" title="Edit Lot">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" data-action="remove-lot" title="Remove Lot">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            // --- DRAG AND DROP ---
            
            function initSortable() {
                // 1. Asset List (Accordion)
                activeSortable.assetSortable = new Sortable(portfolioListEl, {
                    animation: 150,
                    handle: '.asset-drag-handle', // Class of the drag handle
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: handleAssetReorder,
                });

                // 2. Each Lots Table
                const lotTables = portfolioListEl.querySelectorAll('.lots-table-body');
                lotTables.forEach(table => {
                    const sortable = new Sortable(table, {
                        animation: 150,
                        handle: '.lot-drag-handle',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: handleLotReorder,
                    });
                    activeSortable.lotSortables.push(sortable);
                });
                
                // Disable if we are in an edit state
                const isEditing = !!editingLotId || !!document.querySelector('[data-form-type="add-lot"]');
                setSortableState(!isEditing);
            }
            
            /**
             * Called when an asset item is dropped.
             */
            function handleAssetReorder(evt) {
                const movedAssetId = evt.item.dataset.assetId;
                
                // Find the asset and move it in the portfolio array
                const movedAsset = portfolio.find(a => a.id === movedAssetId);
                if (!movedAsset) return;
                
                // Remove from old position
                portfolio = portfolio.filter(a => a.id !== movedAssetId);
                
                // Insert into new position
                portfolio.splice(evt.newIndex, 0, movedAsset);
                
                savePortfolio();
                // No re-render needed, SortableJS handles the DOM
            }
            
            /**
             * Called when a lot item is dropped.
             */
            function handleLotReorder(evt) {
                const lotId = evt.item.dataset.lotId;
                const assetId = evt.from.dataset.assetId; // Get assetId from tbody
                
                const asset = portfolio.find(a => a.id === assetId);
                if (!asset) return;
                
                // Find the lot and move it in the asset.lots array
                const movedLot = asset.lots.find(l => l.id === lotId);
                if (!movedLot) return;
                
                // Remove from old position
                asset.lots = asset.lots.filter(l => l.id !== lotId);
                
                // Insert into new position
                asset.lots.splice(evt.newIndex, 0, movedLot);
                
                savePortfolio();
                
                // Must re-render to update calculations
                renderPortfolio();
            }
            
            // --- EVENT HANDLERS ---
            
            function attachEventListeners() {
                themeToggleBtn.addEventListener('click', toggleTheme);
                langToggleBtn.addEventListener('click', toggleLang);
                mainCurrencySelect.addEventListener('change', () => {
                    applyMainCurrency(mainCurrencySelect.value);
                });
                refreshPricesBtn.addEventListener('click', fetchPrices);
                autoRefreshSelect.addEventListener('change', () => {
                    applyAutoRefresh(autoRefreshSelect.value);
                });
                
                exportSettingsBtn.addEventListener('click', handleExport);
                importFileInput.addEventListener('change', handleImport);
                
                addAssetBtn.addEventListener('click', showNewAssetForm);
                cancelNewAssetBtn.addEventListener('click', hideNewAssetForm);
                saveNewAssetBtn.addEventListener('click', handleSaveNewAsset);
                
                newSymbolInput.addEventListener('keyup', debounce(e => fetchAutocomplete(e.target.value), 300));
                document.addEventListener('click', (e) => {
                    if (!newAssetForm.contains(e.target)) {
                        autocompleteList.classList.add('d-none');
                    }
                });

                portfolioListEl.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const action = target.dataset.action;
                    const row = target.closest('tr');
                    
                    if (action === 'remove-asset') {
                        handleRemoveAsset(target.dataset.assetId);
                    }
                    if (action === 'add-lot') {
                        showAddLotForm(target.dataset.assetId);
                    }
                    if (action === 'remove-lot') {
                        handleRemoveLot(row.dataset.assetId, row.dataset.lotId);
                    }
                    if (action === 'save-lot') {
                        handleSaveLot(target.closest('[data-form-type="add-lot"]'));
                    }
                    if (action === 'cancel-lot') {
                        hideAddLotForm(target.closest('[data-form-type="add-lot"]'));
                    }
                    if (action === 'edit-lot') {
                        handleEditLot(row.dataset.lotId);
                    }
                    if (action === 'save-edit-lot') {
                        handleSaveEditLot(row);
                    }
                    if (action === 'cancel-edit-lot') {
                        handleCancelEditLot();
                    }
                });
                
                portfolioListEl.addEventListener('show.bs.collapse', (e) => {
                    const assetId = e.target.id.replace('collapse-', '');
                    openAccordionItems.add(assetId);
                });
                portfolioListEl.addEventListener('hide.bs.collapse', (e) => {
                    const assetId = e.target.id.replace('collapse-', '');
                    openAccordionItems.delete(assetId);
                });
            }
            
            function showNewAssetForm() {
                newAssetForm.classList.remove('d-none');
                addAssetBtn.classList.add('d-none');
                newSymbolInput.focus();
                setSortableState(false); // Disable dnd
            }
            
            function hideNewAssetForm() {
                newAssetForm.classList.add('d-none');
                addAssetBtn.classList.remove('d-none');
                autocompleteList.classList.add('d-none');
                newSymbolInput.value = '';
                newNameInput.value = '';
                newUnitsInput.value = '';
                newCostInput.value = '';
                newCommissionInput.value = '';
                setSortableState(true); // Enable dnd
            }
            
            function handleSaveNewAsset() {
                const symbol = newSymbolInput.value.trim().toUpperCase();
                const name = newNameInput.value.trim();
                const units = parseFloat(newUnitsInput.value);
                const cost = parseFloat(newCostInput.value);
                const commission = parseFloat(newCommissionInput.value) || 0;
                
                if (!symbol || !name || isNaN(units) || isNaN(cost) || units <= 0 || cost < 0 || commission < 0) {
                    alert(LANGUAGES[currentLang].invalid_input);
                    return;
                }
                
                let asset = portfolio.find(a => a.symbol === symbol);
                
                const newLot = {
                    id: crypto.randomUUID(),
                    assetId: asset ? asset.id : crypto.randomUUID(),
                    units: units,
                    cost: cost,
                    commission: commission
                };
                
                if (asset) {
                    asset.lots.push(newLot);
                } else {
                    asset = {
                        id: newLot.assetId,
                        symbol: symbol,
                        name: name,
                        lots: [newLot]
                    };
                    portfolio.push(asset);
                }
                
                openAccordionItems.add(newLot.assetId);
                
                savePortfolio();
                fetchPrices(); // This will trigger renderPortfolio, which enables dnd
                hideNewAssetForm();
            }
            
            function handleRemoveLot(assetId, lotId) {
                if (confirm(LANGUAGES[currentLang].confirm_remove_lot)) {
                    const asset = portfolio.find(a => a.id === assetId);
                    if (asset) {
                        asset.lots = asset.lots.filter(lot => lot.id !== lotId);
                        
                        if (asset.lots.length === 0) {
                            if (confirm(LANGUAGES[currentLang].confirm_remove_asset)) {
                                handleRemoveAsset(assetId, true); // Pass skipConfirm flag
                            } else {
                                savePortfolio();
                                renderPortfolio();
                            }
                        } else {
                            savePortfolio();
                            renderPortfolio();
                        }
                    }
                }
            }
            
            function handleRemoveAsset(assetId, skipConfirm = false) {
                const doRemove = () => {
                    const assetToRemove = portfolio.find(a => a.id === assetId);
                    if (assetToRemove) {
                         delete currentPrices[assetToRemove.symbol];
                    }
                    portfolio = portfolio.filter(asset => asset.id !== assetId);
                    openAccordionItems.delete(assetId);
                    savePortfolio();
                    renderPortfolio();
                };

                if (skipConfirm) {
                    doRemove();
                } else if (confirm(LANGUAGES[currentLang].confirm_remove_asset)) {
                    doRemove();
                }
            }

            function showAddLotForm(assetId) {
                // Close any other open forms
                const openForm = portfolioListEl.querySelector('[data-form-type="add-lot"]');
                if (openForm) {
                    openForm.remove();
                }
                
                const collapseEl = document.getElementById(`collapse-${assetId}`);
                if (collapseEl) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl);
                    bsCollapse.show();
                }
                
                const container = portfolioListEl.querySelector(`[data-container="add-lot-form"][data-asset-id="${assetId}"]`);
                if (!container) return;
                
                const formClone = addLotFormTemplate.content.cloneNode(true);
                container.appendChild(formClone);
                applyLang(currentLang);
                setSortableState(false); // Disable dnd
            }
            
            function hideAddLotForm(formEl) {
                if (formEl) {
                    formEl.remove();
                }
                setSortableState(true); // Enable dnd
            }
            
            function handleSaveLot(formEl) {
                const unitsInput = formEl.querySelector('[data-input="units"]');
                const costInput = formEl.querySelector('[data-input="cost"]');
                const commissionInput = formEl.querySelector('[data-input="commission"]');
                const assetId = formEl.closest('.accordion-body').querySelector('[data-container="add-lot-form"]').dataset.assetId;
                
                const units = parseFloat(unitsInput.value);
                const cost = parseFloat(costInput.value);
                const commission = parseFloat(commissionInput.value) || 0;
                
                if (isNaN(units) || isNaN(cost) || units <= 0 || cost < 0 || commission < 0) {
                    alert(LANGUAGES[currentLang].invalid_input);
                    return;
                }
                
                const asset = portfolio.find(a => a.id === assetId);
                if (!asset) return;

                const newLot = {
                    id: crypto.randomUUID(),
                    assetId: asset.id,
                    units: units,
                    cost: cost,
                    commission: commission
                };
                
                asset.lots.push(newLot);
                savePortfolio();
                renderPortfolio(); // This will re-enable dnd
            }
            
            // --- EDIT LOT HANDLERS ---
            
            function handleEditLot(lotId) {
                editingLotId = lotId;
                renderPortfolio(); // Re-render to show the edit row
                setSortableState(false); // Disable dnd
            }
            
            function handleCancelEditLot() {
                editingLotId = null;
                renderPortfolio(); // Re-render to cancel
                // Dnd will be re-enabled by renderPortfolio
            }
            
            function handleSaveEditLot(rowEl) {
                const assetId = rowEl.dataset.assetId;
                const lotId = rowEl.dataset.lotId;
                
                const units = parseFloat(rowEl.querySelector('[data-edit="units"]').value);
                const cost = parseFloat(rowEl.querySelector('[data-edit="cost"]').value);
                const commission = parseFloat(rowEl.querySelector('[data-edit="commission"]').value) || 0;
                
                if (isNaN(units) || isNaN(cost) || units < 0 || cost < 0 || commission < 0) { // Allow 0 units
                    alert(LANGUAGES[currentLang].invalid_input);
                    return;
                }
                
                const asset = portfolio.find(a => a.id === assetId);
                if (asset) {
                    const lot = asset.lots.find(l => l.id === lotId);
                    if (lot) {
                        lot.units = units;
                        lot.cost = cost;
                        lot.commission = commission;
                    }
                }
                
                editingLotId = null; // Exit edit mode
                savePortfolio();
                renderPortfolio();
                // Dnd will be re-enabled by renderPortfolio
            }
            
            // --- IMPORT / EXPORT HANDLERS ---
            
            function handleExport() {
                const backupData = {};
                ALL_STORAGE_KEYS.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        backupData[key] = data;
                    }
                });
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const _URL = (window.URL || window.webkitURL);
                const url = _URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `portfolio_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                _URL.revokeObjectURL(url);
            }
            
            function handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm(LANGUAGES[currentLang].import_confirm)) {
                    event.target.value = null;
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        let hasValidKey = false;
                        for (const key of ALL_STORAGE_KEYS) {
                            if (backupData.hasOwnProperty(key)) {
                                hasValidKey = true;
                                break;
                            }
                        }
                        
                        if (!hasValidKey) {
                            throw new Error('Invalid file content.');
                        }
                        
                        ALL_STORAGE_KEYS.forEach(key => {
                            localStorage.removeItem(key);
                        });
                        
                        for (const key in backupData) {
                            if (ALL_STORAGE_KEYS.includes(key)) {
                                localStorage.setItem(key, backupData[key]);
                            }
                        }
                        
                        alert(LANGUAGES[currentLang].import_success);
                        location.reload();
                        
                    } catch (err) {
                        console.error('Import failed:', err);
                        alert(`${LANGUAGES[currentLang].import_error_title}: ${LANGUAGES[currentLang].import_error_invalid_file}`);
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            }


            // --- UTILITY FUNCTIONS ---
            function formatCurrency(value, currency = 'USD') {
                if (typeof value !== 'number') {
                    value = 0;
                }
                
                let langCode = (currentLang === 'pl' ? 'pl-PL' : 'en-US');
                try {
                    value.toLocaleString(langCode);
                } catch (e) {
                    langCode = 'en-US';
                }

                try {
                    return value.toLocaleString(langCode, { 
                        style: 'currency', 
                        currency: currency,
                        maximumFractionDigits: 2,
                        minimumFractionDigits: 2 
                    });
                } catch (e) {
                    return value.toLocaleString(langCode, { 
                        style: 'currency', 
                        currency: 'USD',
                        maximumFractionDigits: 2,
                        minimumFractionDigits: 2 
                    });
                }
            }
            
            function formatPercent(value) {
                if (typeof value !== 'number') {
                    value = 0;
                }
                return value.toFixed(2) + '%';
            }
            
            function getPnLInfo(value) {
                if (value > 0) {
                    return { textClass: 'pl-profit', icon: 'bi-arrow-up' };
                }
                if (value < 0) {
                    return { textClass: 'pl-loss', icon: 'bi-arrow-down' };
                }
                return { textClass: 'text-muted', icon: '' };
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>

