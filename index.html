<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">Portfolio Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Favicon (Money Bag Emoji) -->
    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>" rel="icon">
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
        }

        .footer {
            flex-shrink: 0;
        }

        /* Profit/Loss Colors */
        .pl-profit {
            color: var(--bs-success);
        }
        .pl-loss {
            color: var(--bs-danger);
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            z-index: 1000;
            width: calc(100% - 1.5rem); /* Match form padding */
        }

        /* Helper for alignment in accordion */
        .accordion-header .btn-group {
            margin-left: auto;
            padding-left: 1rem;
        }
        
        .accordion-button:not(.collapsed) {
            box-shadow: none;
        }
        .accordion-button:focus {
             box-shadow: none;
        }
        
        /* Ensure inputs in accordion header are clickable */
        .accordion-header .form-control,
        .accordion-header .btn,
        .accordion-header .input-group-text {
            z-index: 2; /* Place above the accordion button's click area */
            position: relative;
        }
        
        /* New asset form row styling */
        #new-asset-form-row {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
        }
        
        .asset-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 1rem;
            width: 100%;
        }
        
        /* Responsive grid for asset summary */
        @media (min-width: 768px) {
            .asset-summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 992px) {
            .asset-summary-grid {
                grid-template-columns: repeat(4, 1fr); /* Changed from 6 to 4 */
            }
        }

        /* Custom styling for header stats */
        .accordion-button .fw-bold {
            white-space: nowrap;
        }
        
    </style>
</head>
<body class="bg-body-tertiary">

    <!-- Header / Navbar -->
    <header class="p-3 mb-3 border-bottom bg-body-secondary shadow-sm">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-decoration-none h4 mb-0 me-lg-auto">
                     <span class="ms-2" data-lang-key="title">Portfolio Tracker</span>
                </a>

                <div class="ms-3">
                    <button class="btn btn-outline-secondary" id="lang-toggle-btn">PL</button>
                    <button class="btn btn-outline-secondary" id="theme-toggle-btn">
                        <i class="bi bi-sun-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mt-4">
        
        <!-- Portfolio Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <h2 data-lang-key="my_portfolio" class="mb-0">My Portfolio</h2>
                <button class="btn btn-outline-primary btn-sm ms-3" id="refresh-prices-btn">
                    <i class="bi bi-arrow-clockwise"></i> <span data-lang-key="refresh_prices">Refresh Prices</span>
                </button>
            </div>
            <button class="btn btn-primary" id="add-asset-btn">
                <i class="bi bi-plus-circle-fill me-1"></i> <span data-lang-key="add_asset">Add Asset</span>
            </button>
        </div>

        <!-- New Asset Form (Initially hidden) -->
        <div id="new-asset-form-row" class="p-3 mb-3 d-none bg-body-secondary rounded-3">
            <h5 data-lang-key="add_new_asset">Add New Asset</h5>
            <p class="small text-muted" data-lang-key="add_asset_desc">
                Enter the asset's symbol, name, and details for your first purchase lot.
            </p>
            <div class="row g-2 align-items-end">
                <div class="col-md-3 col-6 position-relative">
                    <label for="new-symbol" class="form-label small" data-lang-key="symbol">Symbol</label>
                    <input type="text" class="form-control" id="new-symbol" placeholder="e.g., AAPL" autocomplete="off">
                    <div class="list-group autocomplete-dropdown d-none" id="autocomplete-list">
                        <!-- Autocomplete items go here -->
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <label for="new-name" class="form-label small" data-lang-key="asset_name">Asset Name</label>
                    <input type="text" class="form-control" id="new-name" placeholder="e.g., Apple Inc.">
                </div>
                <div class="col-md-2 col-6">
                    <label for="new-units" class="form-label small" data-lang-key="units">Units</label>
                    <input type="number" class="form-control" id="new-units" placeholder="0.00">
                </div>
                <div class="col-md-2 col-6">
                    <label for="new-cost" class="form-label small" data-lang-key="cost_per_unit">Cost / Unit</label>
                    <input type="number" class="form-control" id="new-cost" placeholder="0.00">
                </div>
                <div class="col-md-2 col-12 d-flex mt-3 mt-md-0">
                    <button class="btn btn-success w-50 me-1" id="save-new-asset-btn">
                        <i class="bi bi-check-lg"></i> <span data-lang-key="save">Save</span>
                    </button>
                    <button class="btn btn-secondary w-50 ms-1" id="cancel-new-asset-btn">
                        <i class="bi bi-x-lg"></i> <span data-lang-key="cancel">Cancel</span>
                    </button>
                </div>
            </div>
            <!-- Autocomplete info box -->
            <div class="form-text mt-2" data-lang-key="autocomplete_info">
                Start typing a symbol to search. Requires a CORS browser extension.
            </div>
        </div>
        
        <!-- Add Lot Form (Template, hidden) -->
        <template id="add-lot-form-template">
             <div class="row g-2 align-items-end p-3 bg-body-tertiary rounded-bottom" data-form-type="add-lot">
                <div class="col-md-4">
                    <label class="form-label small" data-lang-key="units">Units</label>
                    <input type="number" class="form-control" placeholder="0.00" data-input="units">
                </div>
                <div class="col-md-4">
                    <label class="form-label small" data-lang-key="cost_per_unit">Cost / Unit</label>
                    <input type="number" class="form-control" placeholder="0.00" data-input="cost">
                </div>
                <div class="col-md-4 d-flex mt-3 mt-md-0">
                    <button class="btn btn-success w-50 me-1" data-action="save-lot">
                        <i class="bi bi-check-lg"></i> <span data-lang-key="save">Save</span>
                    </button>
                    <button class="btn btn-secondary w-50 ms-1" data-action="cancel-lot">
                        <i class="bi bi-x-lg"></i> <span data-lang-key="cancel">Cancel</span>
                    </button>
                </div>
            </div>
        </template>

        <!-- Portfolio List / Accordion -->
        <div class="accordion" id="portfolio-list">
            <!-- 
            Example Structure (Updated):
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-SYMBOL">
                        <div class="d-flex flex-wrap w-100 align-items-center">
                            
                            <div class="me-auto">
                                <strong class="fs-5 me-2">AAPL</strong>
                                <span class="text-muted">Apple Inc.</span>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <div class="d-none d-md-flex align-items-center me-3">
                                    <div class="me-3 text-end">
                                        <span class="small text-muted">Total Units</span>
                                        <div class="fw-bold">10.00</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="small text-muted">Total Value</span>
                                        <div class="fw-bold">$1,500.00</div>
                                    </div>
                                </div>
                                <div class="btn-group d-none d-lg-flex">
                                     ... buttons ...
                                </div>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse-SYMBOL" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        ... Asset details and lots table ...
                    </div>
                </div>
            </div> 
            -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-body-secondary border-top">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="text-muted" id="version-text">v1.1.0</span>
            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#sourcesModal" data-lang-key="sources">
                Sources
            </button>
        </div>
    </footer>

    <!-- Sources Modal -->
    <div class="modal fade" id="sourcesModal" tabindex="-1" aria-labelledby="sourcesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sourcesModalLabel" data-lang-key="sources">Sources</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p data-lang-key="sources_modal_p1">
                        This application is a client-side portfolio tracker. All data is saved in your browser's local storage.
                    </p>
                    <p data-lang-key="sources_modal_p2">
                        This application attempts to connect directly to Yahoo Finance APIs (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`) to fetch autocomplete suggestions and live market prices.
                    </p>
                    <p data-lang-key="sources_modal_p3">
                        Due to browser security restrictions (CORS), this will <strong>only work if you are using a CORS-blocking browser extension</strong> (like "Allow CORS").
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-lang-key="close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONSTANTS ---
            const STORAGE_KEYS = {
                portfolio: 'portfolioTrackerPortfolio_v1',
                prices: 'portfolioTrackerPrices_v1',
                theme: 'portfolioTrackerTheme_v1',
                lang: 'portfolioTrackerLang_v1'
            };

            const LANGUAGES = {
                en: {
                    title: "Portfolio Tracker",
                    my_portfolio: "My Portfolio",
                    add_asset: "Add Asset",
                    add_new_asset: "Add New Asset",
                    add_asset_desc: "Enter the asset's symbol, name, and details for your first purchase lot.",
                    symbol: "Symbol",
                    asset_name: "Asset Name",
                    units: "Units",
                    cost_per_unit: "Cost / Unit",
                    save: "Save",
                    cancel: "Cancel",
                    autocomplete_info: "Start typing a symbol to search. Requires a CORS browser extension.",
                    sources: "Sources",
                    sources_modal_p1: "This application is a client-side portfolio tracker. All data is saved in your browser's local storage.",
                    sources_modal_p2: "This application attempts to connect directly to Yahoo Finance APIs (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`) to fetch autocomplete suggestions and live market prices.",
                    sources_modal_p3: "Due to browser security restrictions (CORS), this will <strong>only work if you are using a CORS-blocking browser extension</strong> (like \"Allow CORS\").",
                    close: "Close",
                    total_units: "Total Units",
                    avg_cost: "Avg. Cost",
                    total_value: "Total Value",
                    total_pl: "Total P/L",
                    current_price: "Current Price",
                    set: "Set",
                    lots_table: "Lots Table",
                    purchase_cost: "Purchase Cost",
                    current_value: "Current Value",
                    pl: "P/L",
                    actions: "Actions",
                    add_lot: "Add Lot",
                    remove_asset: "Remove Asset",
                    lot_cost: "Lot Cost",
                    refresh_prices: "Refresh Prices",
                    portfolio_empty: "Your portfolio is empty. Click \"Add Asset\" to get started.",
                    fetching_prices: "Fetching prices...",
                    remove_asset_confirm: "Are you sure you want to remove this entire asset and all its lots?",
                    remove_lot_confirm: "Are you sure you want to remove this single lot?"
                },
                pl: {
                    title: "Monitor Portfela",
                    my_portfolio: "M贸j Portfel",
                    add_asset: "Dodaj Aktywo",
                    add_new_asset: "Dodaj Nowe Aktywo",
                    add_asset_desc: "Wprowad藕 symbol, nazw aktywa oraz szczeg贸y pierwszej transakcji zakupu.",
                    symbol: "Symbol",
                    asset_name: "Nazwa Aktywa",
                    units: "Ilo",
                    cost_per_unit: "Koszt / Jedn.",
                    save: "Zapisz",
                    cancel: "Anuluj",
                    autocomplete_info: "Zacznij wpisywa symbol, aby wyszuka. Wymaga rozszerzenia przegldarki blokujcego CORS.",
                    sources: "殴r贸da",
                    sources_modal_p1: "Ta aplikacja to klient-side'owy monitor portfela. Wszystkie dane s zapisywane w lokalnej pamici przegldarki.",
                    sources_modal_p2: "Ta aplikacja pr贸buje czy si bezporednio z API Yahoo Finance (`query1.finance.yahoo.com`, `query2.finance.yahoo.com`), aby pobiera sugestie autouzupeniania i aktualne ceny rynkowe.",
                    sources_modal_p3: "Z powodu ogranicze bezpieczestwa przegldarki (CORS), bdzie to dziaa <strong>tylko jeli u偶ywasz rozszerzenia przegldarki blokujcego CORS</strong> (np. \"Allow CORS\").",
                    close: "Zamknij",
                    total_units: "Suma Jedn.",
                    avg_cost: "r. Koszt",
                    total_value: "Cak. Warto",
                    total_pl: "Cak. Z/S",
                    current_price: "Aktualna Cena",
                    set: "Ustaw",
                    lots_table: "Tabela Transakcji",
                    purchase_cost: "Koszt Zakupu",
                    current_value: "Aktualna Warto",
                    pl: "Z/S",
                    actions: "Akcje",
                    add_lot: "Dodaj Transakcj",
                    remove_asset: "Usu Aktywo",
                    lot_cost: "Koszt Trans.",
                    refresh_prices: "Odwie偶 Ceny",
                    portfolio_empty: "Tw贸j portfel jest pusty. Kliknij \"Dodaj Aktywo\", aby zacz.",
                    fetching_prices: "Pobieranie cen...",
                    remove_asset_confirm: "Czy na pewno chcesz usun cae to aktywo i wszystkie jego transakcje?",
                    remove_lot_confirm: "Czy na pewno chcesz usun t pojedyncz transakcj?"
                }
            };

            // --- STATE ---
            let portfolio = [];
            // currentPrices will store objects like: { "AAPL": { price: 150.00, currency: "USD" } }
            let currentPrices = {};
            let currentTheme = 'dark';
            let currentLang = 'en';
            let autocompleteDebounceTimer;

            // --- DOM REFERENCES ---
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const portfolioListEl = document.getElementById('portfolio-list');
            const addAssetBtn = document.getElementById('add-asset-btn');
            const refreshPricesBtn = document.getElementById('refresh-prices-btn');
            
            // New Asset Form
            const newAssetForm = document.getElementById('new-asset-form-row');
            const newSymbolInput = document.getElementById('new-symbol');
            const autocompleteList = document.getElementById('autocomplete-list');
            const newNameInput = document.getElementById('new-name');
            const newUnitsInput = document.getElementById('new-units');
            const newCostInput = document.getElementById('new-cost');
            const saveNewAssetBtn = document.getElementById('save-new-asset-btn');
            const cancelNewAssetBtn = document.getElementById('cancel-new-asset-btn');
            
            // Add Lot Template
            const addLotFormTemplate = document.getElementById('add-lot-form-template');

            // --- INITIALIZATION ---
            function init() {
                loadTheme();
                loadLang();
                loadPortfolio();
                renderPortfolio();
                attachEventListeners();
                fetchPrices(); // Fetch prices on load
            }
            
            // --- THEME FUNCTIONS ---
            function loadTheme() {
                const storedTheme = localStorage.getItem(STORAGE_KEYS.theme);
                currentTheme = storedTheme || 'dark'; // Default dark
                applyTheme(currentTheme);
            }

            function applyTheme(theme) {
                document.documentElement.dataset.bsTheme = theme;
                themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
                currentTheme = theme;
                localStorage.setItem(STORAGE_KEYS.theme, theme);
            }

            function toggleTheme() {
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            }

            // --- LANGUAGE FUNCTIONS ---
            function loadLang() {
                const storedLang = localStorage.getItem(STORAGE_KEYS.lang);
                currentLang = storedLang || 'en'; // Default English
                applyLang(currentLang);
            }

            function applyLang(lang) {
                currentLang = lang;
                localStorage.setItem(STORAGE_KEYS.lang, lang);
                langToggleBtn.textContent = lang === 'en' ? 'PL' : 'EN';
                
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if (LANGUAGES[lang] && LANGUAGES[lang][key]) {
                        el.innerHTML = LANGUAGES[lang][key];
                    }
                });
                
                // Update dynamic placeholder text
                document.documentElement.lang = lang;
            }

            function toggleLang() {
                applyLang(currentLang === 'en' ? 'pl' : 'en');
                // Re-render to update dynamic text in portfolio
                renderPortfolio();
            }

            // --- PORTFOLIO DATA FUNCTIONS ---
            function loadPortfolio() {
                try {
                    portfolio = JSON.parse(localStorage.getItem(STORAGE_KEYS.portfolio)) || [];
                } catch (e) {
                    console.error('Error parsing portfolio from localStorage:', e);
                    portfolio = []; // Reset to empty array on error
                    localStorage.removeItem(STORAGE_KEYS.portfolio); // Clear corrupted data
                }
                
                try {
                    currentPrices = JSON.parse(localStorage.getItem(STORAGE_KEYS.prices)) || {};
                } catch (e) {
                    console.error('Error parsing prices from localStorage:', e);
                    currentPrices = {}; // Reset to empty object on error
                    localStorage.removeItem(STORAGE_KEYS.prices); // Clear corrupted data
                }
            }

            function savePortfolio() {
                localStorage.setItem(STORAGE_KEYS.portfolio, JSON.stringify(portfolio));
                localStorage.setItem(STORAGE_KEYS.prices, JSON.stringify(currentPrices));
            }

            // --- API FUNCTIONS ---
            
            /**
             * Debounce utility to prevent excessive API calls
             */
            function debounce(func, delay) {
                return function(...args) {
                    clearTimeout(autocompleteDebounceTimer);
                    autocompleteDebounceTimer = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            }
            
            /**
             * Fetch autocomplete suggestions from Yahoo Finance
             */
            async function fetchAutocomplete(query) {
                if (query.length < 1) {
                    autocompleteList.classList.add('d-none');
                    return;
                }
                
                try {
                    // Using the new search URL provided
                    const response = await fetch(`https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&lang=en-US&region=US&quotesCount=7&enableCb=false&enableNavLinks=true`);
                    if (!response.ok) throw new Error('Autocomplete API response not ok');
                    
                    const data = await response.json();
                    // The new API returns suggestions in the 'quotes' array
                    const suggestions = data.quotes; 
                    
                    renderAutocomplete(suggestions);
                    
                } catch (error) {
                    console.error('Error fetching autocomplete:', error);
                    autocompleteList.classList.add('d-none');
                }
            }
            
            function renderAutocomplete(suggestions) {
                autocompleteList.innerHTML = '';
                if (!suggestions || suggestions.length === 0) {
                    autocompleteList.classList.add('d-none');
                    return;
                }
                
                suggestions.slice(0, 7).forEach(item => {
                    // New API structure uses longname or shortname
                    const name = item.longname || item.shortname || item.symbol;
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'list-group-item list-group-item-action';
                    el.innerHTML = `<strong>${item.symbol}</strong> - <small>${name}</small>`;
                    el.dataset.symbol = item.symbol;
                    el.dataset.name = name;
                    
                    el.addEventListener('click', () => {
                        newSymbolInput.value = item.symbol;
                        newNameInput.value = name;
                        autocompleteList.classList.add('d-none');
                        newUnitsInput.focus();
                    });
                    
                    autocompleteList.appendChild(el);
                });
                
                autocompleteList.classList.remove('d-none');
            }
            
            /**
             * Fetch current prices for all assets in portfolio
             */
            async function fetchPrices() {
                if (portfolio.length === 0) return;
                
                const originalBtnText = refreshPricesBtn.innerHTML;
                refreshPricesBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <span data-lang-key="fetching_prices">Fetching...</span>`;
                refreshPricesBtn.disabled = true;
                applyLang(currentLang);

                // We can no longer fetch in a single batch. We must fetch one by one.
                const symbols = portfolio.map(asset => asset.symbol);
                
                try {
                    // Create date range for chart (e.g., last day)
                    const period2 = Math.floor(Date.now() / 1000); // Now
                    const period1 = period2 - (24 * 60 * 60); // 1 day ago (in seconds)
                    
                    const pricePromises = symbols.map(symbol => {
                        // Use the new URL structure, replacing the hardcoded symbol and periods
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${period1}&period2=${period2}&interval=1m&includePrePost=true&events=div%7Csplit%7Cearn&lang=en-US&region=US`;
                        
                        return fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    console.warn(`Failed to fetch price for ${symbol}`);
                                    return null; // Don't block other requests
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data && data.chart && data.chart.result && data.chart.result[0] && data.chart.result[0].meta) {
                                    // *** CHANGED: Get price and currency ***
                                    const meta = data.chart.result[0].meta;
                                    const price = meta.regularMarketPrice;
                                    const currency = meta.currency;
                                    return { symbol, price, currency };
                                } else {
                                    console.warn(`Unexpected data structure for ${symbol}`, data);
                                    return null;
                                }
                            })
                            .catch(err => {
                                console.error(`Error fetching ${symbol}:`, err);
                                return null; // Handle individual failures
                            });
                    });
                    
                    const results = await Promise.all(pricePromises);
                    
                    let pricesUpdated = false;
                    results.forEach(result => {
                        // *** CHANGED: Store price and currency object ***
                        if (result && result.price !== undefined) {
                            currentPrices[result.symbol] = {
                                price: result.price || 0,
                                currency: result.currency || 'USD' // Fallback to USD
                            };
                            pricesUpdated = true;
                        }
                    });
                    
                    if (pricesUpdated) {
                        savePortfolio();
                        renderPortfolio();
                    }
                    
                } catch (error) {
                    console.error('Error fetching prices:', error);
                    alert('Error fetching prices. Please ensure your CORS extension is active and try again.');
                } finally {
                    refreshPricesBtn.innerHTML = originalBtnText;
                    refreshPricesBtn.disabled = false;
                    applyLang(currentLang);
                }
            }


            // --- RENDERING ---
            function renderPortfolio() {
                portfolioListEl.innerHTML = ''; // Clear list
                
                if (portfolio.length === 0) {
                     portfolioListEl.innerHTML = `<div class="alert alert-info" data-lang-key="portfolio_empty">Your portfolio is empty. Click "Add Asset" to get started.</div>`;
                     applyLang(currentLang); // Apply lang to new element
                     return;
                }

                portfolio.forEach(asset => {
                    const assetEl = createAssetElement(asset);
                    portfolioListEl.appendChild(assetEl);
                });
                
                // Re-apply language to all newly created elements
                applyLang(currentLang);
            }
            
            function createAssetElement(asset) {
                // *** CHANGED: Get price and currency from stored object ***
                const currentPriceData = currentPrices[asset.symbol] || { price: 0, currency: 'USD' };
                const currentPrice = currentPriceData.price;
                const currency = currentPriceData.currency;
                
                // Calculate totals
                // *** CHANGED: Added (lot.units || 0) to prevent NaN from undefined data ***
                const totalUnits = asset.lots.reduce((sum, lot) => sum + (lot.units || 0), 0);
                // *** CHANGED: Added (lot.units || 0) and (lot.cost || 0) to prevent NaN ***
                const totalCost = asset.lots.reduce((sum, lot) => sum + ((lot.units || 0) * (lot.cost || 0)), 0);
                const avgCost = totalUnits > 0 ? totalCost / totalUnits : 0;
                const totalValue = totalUnits * currentPrice;
                const totalPL = totalValue - totalCost;
                const totalPLPercent = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
                const plInfo = getPnLInfo(totalPL);

                const template = document.createElement('div');
                template.className = 'accordion-item';
                
                // *** CHANGED: Updated accordion button layout ***
                template.innerHTML = `
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${asset.id}">
                            <div class="d-flex flex-wrap w-100 align-items-center">
                                
                                <!-- Left Side: Symbol & Name -->
                                <div class="me-auto">
                                    <strong class="fs-5 me-2">${asset.symbol}</strong>
                                    <span class="text-muted">${asset.name}</span>
                                </div>
                                
                                <!-- Right Side: Stats & Buttons -->
                                <div class="d-flex align-items-center">
                                    <!-- Stats (hidden on small, shown on medium+) -->
                                    <div class="d-none d-md-flex align-items-center me-3">
                                        <div class="me-3 text-end">
                                            <span class="small text-muted" data-lang-key="total_units">Total Units</span>
                                            <div class="fw-bold">${totalUnits.toFixed(2)}</div>
                                        </div>
                                        <div class="me-3 text-end">
                                            <span class="small text-muted" data-lang-key="current_price">Current Price</span>
                                            <div class="fw-bold">${formatCurrency(currentPrice, currency)}</div>
                                        </div>
                                        <div class="me-3 text-end">
                                            <span class="small text-muted" data-lang-key="total_value">Total Value</span>
                                            <div class="fw-bold">${formatCurrency(totalValue, currency)}</div>
                                        </div>
                                        <div class="text-end ${plInfo.textClass}">
                                            <span class="small text-muted" data-lang-key="total_pl">Total P/L</span>
                                            <div class="fw-bold">${formatCurrency(totalPL, currency)} (${formatPercent(totalPLPercent)})</div>
                                        </div>
                                    </div>

                                    <!-- Buttons (part of original code) -->
                                    <div class="btn-group d-none d-lg-flex" role="group">
                                        <button class="btn btn-sm btn-outline-success" data-action="add-lot" data-asset-id="${asset.id}" title="Add Lot">
                                            <i class="bi bi-plus-lg"></i> <span data-lang-key="add_lot">Add Lot</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" data-action="remove-asset" data-asset-id="${asset.id}" title="Remove Asset">
                                            <i class="bi bi-trash-fill"></i> <span data-lang-key="remove_asset">Remove Asset</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-${asset.id}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <!-- Asset Summary -->
                            <div class="asset-summary-grid mb-3">
                                <div>
                                    <span class="small text-muted" data-lang-key="total_units">Total Units</span>
                                    <div class="fs-5">${totalUnits.toFixed(2)}</div>
                                </div>
                                <div>
                                    <span class="small text-muted" data-lang-key="avg_cost">Avg. Cost</span>
                                    <div class="fs-5">${formatCurrency(avgCost, currency)}</div>
                                </div>
                                <div>
                                    <span class="small text-muted" data-lang-key="total_value">Total Value</span>
                                    <div class="fs-5">${formatCurrency(totalValue, currency)}</div>
                                </div>
                                <div class="${plInfo.textClass}">
                                    <span class="small text-muted" data-lang-key="total_pl">Total P/L</span>
                                    <div class="fs-5">
                                        ${formatCurrency(totalPL, currency)} <i class="bi ${plInfo.icon}"></i>
                                        (${formatPercent(totalPLPercent)})
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <span class="small text-muted" data-lang-key="current_price">Current Price</span>
                                    <div class="fs-5">${formatCurrency(currentPrice, currency)}</div>
                                </div>
                            </div>
                            
                            <!-- Small screen buttons -->
                            <div class="d-lg-none btn-group w-100 mb-3">
                                <button class="btn btn-sm btn-outline-success" data-action="add-lot" data-asset-id="${asset.id}" title="Add Lot">
                                    <i class="bi bi-plus-lg"></i> <span data-lang-key="add_lot">Add Lot</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="remove-asset" data-asset-id="${asset.id}" title="Remove Asset">
                                    <i class="bi bi-trash-fill"></i> <span data-lang-key="remove_asset">Remove Asset</span>
                                </button>
                            </div>

                            <!-- Lots Table -->
                            <h6 data-lang-key="lots_table">Lots</h6>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th data-lang-key="units">Units</th>
                                            <th data-lang-key="cost_per_unit">Cost / Unit</th>
                                            <th data-lang-key="lot_cost">Lot Cost</th>
                                            <th data-lang-key="current_value">Current Value</th>
                                            <th data-lang-key="pl">P/L</th>
                                            <th data-lang-key="actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- *** CHANGED: Pass currency to createLotRow *** -->
                                        ${asset.lots.map(lot => createLotRow(lot, currentPrice, currency)).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Add Lot Form placeholder -->
                            <div data-container="add-lot-form" data-asset-id="${asset.id}"></div>
                        </div>
                    </div>
                `;
                return template;
            }
            
            // *** CHANGED: Accept currency parameter ***
            function createLotRow(lot, currentPrice, currency) {
                // *** CHANGED: Add fallbacks for units and cost to prevent errors from bad data ***
                const units = lot.units || 0;
                const cost = lot.cost || 0;
                
                const lotCost = units * cost;
                const lotValue = units * currentPrice;
                const lotPL = lotValue - lotCost;
                const lotPLPercent = lotCost > 0 ? (lotPL / lotCost) * 100 : 0;
                const plInfo = getPnLInfo(lotPL);
                
                return `
                    <tr data-lot-id="${lot.id}">
                        <td>${units.toFixed(2)}</td>
                        <td>${formatCurrency(cost, currency)}</td>
                        <td>${formatCurrency(lotCost, currency)}</td>
                        <td>${formatCurrency(lotValue, currency)}</td>
                        <td class="${plInfo.textClass}">
                            ${formatCurrency(lotPL, currency)}
                            (${formatPercent(lotPLPercent)})
                            <i class="bi ${plInfo.icon}"></i>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" data-action="remove-lot" data-asset-id="${lot.assetId}" data-lot-id="${lot.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            // --- EVENT HANDLERS ---
            
            function attachEventListeners() {
                themeToggleBtn.addEventListener('click', toggleTheme);
                langToggleBtn.addEventListener('click', toggleLang);
                refreshPricesBtn.addEventListener('click', fetchPrices);
                
                // New Asset Form
                addAssetBtn.addEventListener('click', showNewAssetForm);
                cancelNewAssetBtn.addEventListener('click', hideNewAssetForm);
                saveNewAssetBtn.addEventListener('click', handleSaveNewAsset);
                
                // Autocomplete
                newSymbolInput.addEventListener('keyup', debounce(e => fetchAutocomplete(e.target.value), 300));
                // Hide autocomplete if clicking outside
                document.addEventListener('click', (e) => {
                    if (!newAssetForm.contains(e.target)) {
                        autocompleteList.classList.add('d-none');
                    }
                });

                // Portfolio List (Event Delegation)
                portfolioListEl.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    
                    const action = target.dataset.action;
                    
                    if (action === 'remove-asset') {
                        handleRemoveAsset(target.dataset.assetId);
                    }
                    if (action === 'add-lot') {
                        showAddLotForm(target.dataset.assetId);
                    }
                    if (action === 'remove-lot') {
                        handleRemoveLot(target.dataset.assetId, target.dataset.lotId);
                    }
                    if (action === 'save-lot') {
                        handleSaveLot(target.closest('[data-form-type="add-lot"]'));
                    }
                    if (action === 'cancel-lot') {
                        hideAddLotForm(target.closest('[data-form-type="add-lot"]'));
                    }
                });
            }
            
            function showNewAssetForm() {
                newAssetForm.classList.remove('d-none');
                addAssetBtn.classList.add('d-none');
                newSymbolInput.focus();
            }
            
            function hideNewAssetForm() {
                newAssetForm.classList.add('d-none');
                addAssetBtn.classList.remove('d-none');
                autocompleteList.classList.add('d-none');
                // Clear inputs
                newSymbolInput.value = '';
                newNameInput.value = '';
                newUnitsInput.value = '';
                newCostInput.value = '';
            }
            
            function handleSaveNewAsset() {
                const symbol = newSymbolInput.value.trim().toUpperCase();
                const name = newNameInput.value.trim();
                const units = parseFloat(newUnitsInput.value);
                const cost = parseFloat(newCostInput.value);
                
                if (!symbol || !name || isNaN(units) || isNaN(cost) || units <= 0 || cost < 0) {
                    // Simple validation
                    alert('Please fill in all fields with valid data. Units must be > 0 and cost must be >= 0.');
                    return;
                }
                
                // Check if asset already exists
                let asset = portfolio.find(a => a.symbol === symbol);
                
                const newLot = {
                    id: crypto.randomUUID(),
                    assetId: asset ? asset.id : crypto.randomUUID(),
                    units: units,
                    cost: cost
                };
                
                if (asset) {
                    // Add lot to existing asset
                    asset.lots.push(newLot);
                } else {
                    // Create new asset
                    asset = {
                        id: newLot.assetId,
                        symbol: symbol,
                        name: name,
                        lots: [newLot]
                    };
                    portfolio.push(asset);
                }
                
                savePortfolio();
                renderPortfolio();
                hideNewAssetForm();
                
                // Fetch price for the new asset
                fetchPrices();
            }
            
            // *** CHANGED: Cleaned up duplicate function ***
            function handleRemoveAsset(assetId) {
                // Using a simple confirm. A custom modal would be better for UX.
                if (confirm(LANGUAGES[currentLang].remove_asset_confirm)) {
                    const assetToRemove = portfolio.find(a => a.id === assetId);
                    if (assetToRemove) {
                         delete currentPrices[assetToRemove.symbol];
                    }
                    
                    portfolio = portfolio.filter(asset => asset.id !== assetId);
                    
                    savePortfolio();
                    renderPortfolio();
                }
            }

            function showAddLotForm(assetId) {
                // Close any other open forms
                const openForm = portfolioListEl.querySelector('[data-form-type="add-lot"]');
                if (openForm) {
                    openForm.remove();
                }
                
                const container = portfolioListEl.querySelector(`[data-container="add-lot-form"][data-asset-id="${assetId}"]`);
                if (!container) return;
                
                const formClone = addLotFormTemplate.content.cloneNode(true);
                container.appendChild(formClone);
                applyLang(currentLang); // Translate new form
                
                // Focus the first input in the new form
                container.querySelector('[data-input="units"]').focus();
            }
            
            function hideAddLotForm(formEl) {
                if (formEl) {
                    formEl.remove();
                }
            }
            
            function handleSaveLot(formEl) {
                if (!formEl) return;
                
                const container = formEl.closest('[data-container="add-lot-form"]');
                const assetId = container.dataset.assetId;
                
                const unitsInput = formEl.querySelector('[data-input="units"]');
                const costInput = formEl.querySelector('[data-input="cost"]');
                
                const units = parseFloat(unitsInput.value);
                const cost = parseFloat(costInput.value);

                if (isNaN(units) || isNaN(cost) || units <= 0 || cost < 0) {
                     alert('Please fill in all fields with valid data. Units must be > 0 and cost must be >= 0.');
                    return;
                }
                
                const asset = portfolio.find(a => a.id === assetId);
                if (!asset) return;
                
                const newLot = {
                    id: crypto.randomUUID(),
                    assetId: asset.id,
                    units: units,
                    cost: cost
                };
                
                asset.lots.push(newLot);
                savePortfolio();
                renderPortfolio();
                // Note: The renderPortfolio call will close the add lot form.
                // To keep it open, we would need to re-render just the table,
                // but re-rendering all is simpler and fine for this app.
            }
            
            function handleRemoveLot(assetId, lotId) {
                 if (confirm(LANGUAGES[currentLang].remove_lot_confirm)) {
                    const asset = portfolio.find(a => a.id === assetId);
                    if (!asset) return;
                    
                    asset.lots = asset.lots.filter(lot => lot.id !== lotId);
                    
                    // Check if this was the last lot
                    if (asset.lots.length === 0) {
                        // If last lot is removed, remove the whole asset
                        handleRemoveAsset(asset.id);
                    } else {
                        savePortfolio();
                        renderPortfolio();
                    }
                }
            }


            // --- UTILITY FUNCTIONS ---
            
            // *** CHANGED: Accept currencyCode, add error handling ***
            function formatCurrency(value, currencyCode = 'USD') {
                if (!currencyCode) {
                    currencyCode = 'USD'; // Default fallback
                }
                
                try {
                    return value.toLocaleString(currentLang === 'pl' ? 'pl-PL' : 'en-US', { 
                        style: 'currency', 
                        currency: currencyCode,
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                } catch (e) {
                    // Handle invalid currency code, e.g., from old stored data
                    // console.warn(`Invalid currency code "${currencyCode}", falling back to USD.`);
                    return value.toLocaleString(currentLang === 'pl' ? 'pl-PL' : 'en-US', { 
                        style: 'currency', 
                        currency: 'USD', // Fallback to USD
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            }
            
            function formatPercent(value) {
                return value.toFixed(2) + '%';
            }
            
            function getPnLInfo(value) {
                if (value > 0.001) { // Use small tolerance for floating point
                    return { textClass: 'pl-profit', icon: 'bi-arrow-up' };
                }
                if (value < -0.001) { // Use small tolerance for floating point
                    return { textClass: 'pl-loss', icon: 'bi-arrow-down' };
                }
                return { textClass: 'text-muted', icon: '' };
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>



